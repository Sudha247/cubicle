##########################################################################
#                                                                        #
#     The Alt-ergo theorem prover                                        #
#     Copyright (C) 2006-2010                                            #
#                                                                        #
#     Sylvain Conchon                                                    #
#     Evelyne Contejean                                                  #
#     Stephane Lescuyer                                                  #
#     Mohamed Iguernelala                                                #
#     Alain Mebsout                                                      #
#                                                                        #
#     CNRS - INRIA - Universite Paris Sud                                #
#                                                                        #
#   This file is distributed under the terms of the CeCILL-C licence     #
#                                                                        #
##########################################################################

# sample Makefile for Objective Caml
# Copyright (C) 2001 Jean-Christophe FILLIATRE
# 
# This library is free software; you can redistribute it and/or
# modify it under the terms of the GNU Library General Public
# License version 2, as published by the Free Software Foundation.
# 
# This library is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# 
# See the GNU Library General Public License version 2 for more details
# (enclosed in the file LGPL).

# where to install the binaries
DESTDIR=
prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR=$(DESTDIR)@bindir@
LIBDIR=$(DESTDIR)@libdir@/alt-ergo

# where to install the man page
MANDIR=$(DESTDIR)@mandir@

# other variables set by ./configure
OCAMLC   = @OCAMLC@
OCAMLOPT = @OCAMLOPT@
OCAMLDEP = @OCAMLDEP@
OCAMLLEX = @OCAMLLEX@
OCAMLYACC= @OCAMLYACC@
OCAMLLIB = @OCAMLLIB@
OCAMLBEST= @OCAMLBEST@
OCAMLVERSION = @OCAMLVERSION@
OCAMLWIN32 = @OCAMLWIN32@
EXE = @EXE@

BFLAGS = -dtypes -g -annot
OFLAGS = -dtypes -annot -for-pack AltErgo

BIBBYTE=nums.cma unix.cma

BIBOPT=$(BIBBYTE:.cma=.cmxa)

# main target
#############

NAME = alt-ergo
LIBNAME = altErgo
BYTE=$(NAME).byte
OPT=$(NAME).opt

all: pack xpack $(OCAMLBEST) pack xpack

# bytecode and native-code compilation
######################################


PRECMO = version.cmo print_color.cmo preoptions.cmo

OPTIONSCMO = parseoptions.cmo

CMO = options.cmo exception.cmo loc.cmo timer.cmo \
      vec.cmo heap.cmo \
      hashcons.cmo hstring.cmo builtin.cmo symbols.cmo \
      subst.cmo ty.cmo common.cmo term.cmo literal.cmo formula.cmo \
      debug1.cmo solver_types.cmo explanation.cmo \
      why_parser.cmo why_lexer.cmo pretty.cmo \
      polynome.cmo ac.cmo \
      uf.cmo use.cmo intervals.cmo fm.cmo arith.cmo \
      records.cmo sum.cmo \
      combine.cmo cc.cmo solver.cmo \
      existantial.cmo \
      triggers.cmo cnf.cmo why_typing.cmo matching.cmo \
      sat.cmo 

CMOFRONT = frontend.cmo

PRECMX = $(PRECMO:.cmo=.cmx)
OPTIONSCMX = $(OPTIONSCMO:.cmo=.cmx)
CMX = $(CMO:.cmo=.cmx)
CMXFRONT = $(CMOFRONT:.cmo=.cmx)

MAINCMO = $(CMO) $(CMOFRONT) main.cmo
MAINCMX = $(MAINCMO:.cmo=.cmx)

RUNCMO = $(CMO) run.cmo
RUNCMX = $(RUNCMO:.cmo=.cmx)

GENERATED = version.ml \
	why_parser.ml why_parser.mli why_lexer.ml

byte: $(NAME).byte
opt: $(NAME).opt

$(NAME).byte: $(PRECMO) $(OPTIONSCMO) $(MAINCMO) 
	$(if $(QUIET),@echo 'Linking $@' &&) 
	$(OCAMLC) $(BFLAGS) -o $@ $(BIBBYTE) $^

$(LIBNAME).cmo: $(PRECMO) $(CMO) 
	$(if $(QUIET),@echo 'Library $@' &&) 
	$(OCAMLC) $(BFLAGS) -pack -o $(LIBNAME).cmo $^

pack: $(LIBNAME).cmo

$(LIBNAME).cmx: $(PRECMX) $(CMX)
	$(if $(QUIET),@echo 'Library $@' &&) 
	$(OCAMLOPT) $(INCLUDES)  -pack -o $(LIBNAME).cmx $^

xpack: $(LIBNAME).cmx

$(NAME).opt: $(PRECMX) $(OPTIONSCMX) $(MAINCMX)
	$(if $(QUIET),@echo 'Linking $@' &&) 
	$(OCAMLOPT) $(OFLAGS) -o $@ $(BIBOPT) $^

VERSION=0.93-satml

version.ml: config.status
	@echo "let version = \""$(VERSION)"\"" > version.ml
	@echo "let date = \""`date`"\"" >> version.ml
	@echo "let libdir = \""$(LIBDIR)"\"" >> version.ml



# file headers
##############
headers:
	headache -c doc/headache_config.txt -h doc/alt-ergoheader.txt \
		Makefile.in configure.in README INSTALL \
		*.ml *.ml[ily]


# installation
##############

install-indep: install-man install-prelude install-pack

install: install-indep 
	mkdir -p $(BINDIR)
	cp -f $(NAME).$(OCAMLBEST) $(BINDIR)/$(NAME)$(EXE)

install-byte: install-indep
	mkdir -p $(BINDIR)
	cp -f $(NAME).byte $(BINDIR)/$(NAME)$(EXE)

install-opt: install-indep
	mkdir -p $(BINDIR)
	cp -f $(NAME).opt $(BINDIR)/$(NAME)$(EXE)

install-man:
	mkdir -p $(MANDIR)/man1
	cp -f doc/*.1 $(MANDIR)/man1

install-pack: xpack pack
	mkdir -p $(LIBDIR)
	cp -f $(LIBNAME).cmx $(LIBDIR)
	cp -f $(LIBNAME).o $(LIBDIR)
	cp -f $(LIBNAME).cmo $(LIBDIR)
	cp -f $(LIBNAME).cmi $(LIBDIR)

# documentation
###############

DOCFILES=

doc: $(DOCFILES)


# generic rules
###############

.SUFFIXES: .mli .ml .cmi .cmo .cmx .mll .mly .tex .dvi .ps .html

.mli.cmi:
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLC) -c $(BFLAGS) $<

.ml.cmo:
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLC) -c $(BFLAGS) $<
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 

.ml.o:
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLOPT) -c $(OFLAGS) $<

.ml.cmx:
	$(if $(QUIET),@echo 'Compiling $@' &&) $(OCAMLOPT) -c $(OFLAGS) $<
	@@OCAMLWIZARD@ compile -w a $(BFLAGS) $< 

.mll.ml:
	$(if $(QUIET),@echo 'Compiling $<' &&) $(OCAMLLEX) $< > /dev/null

.mly.ml:
	$(if $(QUIET),@echo 'Compiling $<' &&) $(OCAMLYACC) -v $< 

.mly.mli:
	$(if $(QUIET),@echo 'Compiling $<' &&) $(OCAMLYACC) -v $< 

.tex.dvi:
	latex $< && latex $<

.dvi.ps:
	dvips $< -o $@ 

.tex.html:
	hevea $<

# Emacs tags
############

tags:
	find . -name "*.ml*" | sort -r | xargs \
	etags "--regex=/let[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/let[ \t]+rec[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/and[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/type[ \t]+\([^ \t]+\)/\1/" \
              "--regex=/exception[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/val[ \t]+\([^ \t]+\)/\1/" \
	      "--regex=/module[ \t]+\([^ \t]+\)/\1/"

# Makefile is rebuilt whenever Makefile.in or configure.in is modified
######################################################################

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck

configure: configure.in
	autoconf 

# clean
#######

clean:: 
	@rm -f *.cm[iox] *.o *~ *.annot *.owz *mlocamlwizard_tmp_file*
	@rm -f $(GENERATED) *.output
	@rm -f $(NAME).byte $(NAME).opt
	@rm -f unittest/*.cm[iox] unittest/*.o unittest/*.annot
	@rm -f *.aux *.log $(NAME).tex $(NAME).dvi $(NAME).ps
	@rm -f version.ml

dist-clean distclean:: clean
	@rm -f Makefile config.cache config.log config.status

# depend
########

.depend depend:: $(GENERATED)
	@rm -f .depend
	@$(OCAMLDEP) -slash *.ml *.mli > .depend

include .depend
