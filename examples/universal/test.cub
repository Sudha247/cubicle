(* splitter with cubicle *)

(* Model inspired by the Pluscal version (more precisely, by the translation
  in TLA+ of the Pluscal version).
  Tentative to express the safe states by counting. Cubicle runs forever (> 15h) without conclusion.
*)

(* number_procs 4 *)

type directions = None | Right | Stop | Down

type pc = PC0 | PC1 | PC2 | PC3 | PC4 | PC5 | PC6 | PC7 | PC8 | PC9

var X : proc
var Y : bool
array Rval[proc] : directions
array PC[proc] : pc

(* ================================================================ *)
(* Tentative d'invariants *)
(* ================================================================ *)

init(i) { Rval[i] = None && Y = False && PC[i] = PC0 }

(* ================================================================ *)

(* unsafe () { Error = True } *)
universal_unsafe (i, j) { PC[i] = PC6 && PC[j] = PC9 }
universal_unsafe (i) { PC[i] = PC6 }
universal_unsafe (i) { PC[i] = PC9 }

(* ================================================================ *)
(* Unsafe from merci *)
(* ================================================================ *)

(* ================================================================ *)

(* transition error(i) *)
(* requires {PC[i] = PC9 && forall_other j. PC[j] = PC9 } *)
(* { Error := True } *)

transition spl0(i)
requires { PC[i] = PC0 }
{
        X := i;
        PC[i] := PC1;
}

transition spl1a(i)
requires { PC[i] = PC1 && Y = True }
{
        PC[i] := PC2
}

transition spl1b(i)
requires { PC[i] = PC1 && Y = False }
{
        PC[i] := PC3
}

transition spl2(i)
requires { PC[i] = PC2 }
{
        Rval[i] := Right;
        PC[i] := PC7
}

transition spl3(i)
requires { PC[i] = PC3 }
{
        Y := True;
        PC[i] := PC4
}

transition spl4a(i)
requires { PC[i] = PC4 && X = i }
{
        PC[i] := PC5
}

transition spl4b(i)
requires { PC[i] = PC4 && X <> i }
{
        PC[i] := PC6
}

transition spl5(i)
requires { PC[i] = PC5 }
{
        Rval[i] := Stop;
        PC[i] := PC8
}

transition spl6(i)
requires { PC[i] = PC6 }
{
        Rval[i] := Down;
        PC[i] := PC9
}
